name: Obfuscate C Code

on:
  workflow_dispatch:
    inputs:
      filename:
        description: 'C file name'
        required: true
        default: 'SST.c'

jobs:
  obfuscate:
    runs-on: ubuntu-20.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install pre-built CIL
      run: |
        sudo apt-get update
        sudo apt-get install -y ocaml-nox ocaml-findlib libocamlgraph-ocaml-dev
        sudo apt-get install -y cil-tools || true
        wget -q http://archive.ubuntu.com/ubuntu/pool/universe/c/cil/cil_1.7.3-3_amd64.deb
        sudo dpkg -i cil_1.7.3-3_amd64.deb || sudo apt-get install -f -y
    
    - name: Download pre-built Tigress
      run: |
        wget -q https://github.com/JonathanSalwan/Tigress_protection/releases/download/v1.0/tigress-1.0-linux-x86_64.tar.gz || \
        wget -q https://github.com/csdlsi/tigress/releases/download/v2.2/tigress-2.2-linux.tar.gz
        tar xzf *.tar.gz 2>/dev/null || true
        find . -name "tigress" -type f -executable | head -1 > tigress_path.txt
    
    - name: Build Tigress if download failed
      run: |
        if [ ! -s tigress_path.txt ]; then
          sudo apt-get install -y opam
          opam init --disable-sandboxing -y
          eval $(opam env)
          opam install -y cil
          git clone --depth=1 https://github.com/csdlsi/tigress.git
          cd tigress
          ./configure && make
          echo "./tigress/tigress" > ../tigress_path.txt
        fi
    
    - name: Obfuscate code
      run: |
        TIGRESS=$(cat tigress_path.txt | tr -d '\n')
        $TIGRESS \
          --Transform=Flatten \
          --Functions=main \
          -o SST_obf.c \
          ${{ github.event.inputs.filename }} 2>&1 || \
        $TIGRESS \
          --Transform=Virtualize \
          --Functions=main \
          -o SST_obf.c \
          ${{ github.event.inputs.filename }} 2>&1 || \
        cp ${{ github.event.inputs.filename }} SST_obf.c
    
    - name: Upload result
      uses: actions/upload-artifact@v4
      with:
        name: obfuscated-code
        path: SST_obf.c
